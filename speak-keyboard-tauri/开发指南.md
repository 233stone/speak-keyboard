# 语音输入助手 - 开发指南

## 项目结构

```
speak-keyboard-tauri/
├── src/                    # Vue源代码
│   ├── components/        # Vue组件
│   │   ├── Widget.vue    # 悬浮窗组件
│   │   └── Settings.vue  # 设置窗口组件
│   ├── App.vue           # 主应用组件
│   ├── main.js           # 入口文件
│   └── style.css         # 全局样式（含Tailwind）
├── src-tauri/            # Rust后端代码
│   ├── src/
│   │   ├── main.rs       # Rust入口
│   │   └── lib.rs        # 主要逻辑（托盘、快捷键等）
│   ├── Cargo.toml        # Rust依赖
│   └── tauri.conf.json   # Tauri配置
├── public/               # 静态资源
├── package.json          # Node.js依赖
├── tailwind.config.js    # Tailwind配置
└── vite.config.js        # Vite配置
```

## 技术栈

### 前端
- **Vue 3** - 响应式UI框架
- **Tailwind CSS** - 实用优先的CSS框架
- **Font Awesome** - 图标库
- **Vite** - 快速构建工具

### 后端
- **Tauri 2** - 桌面应用框架
- **Rust** - 系统级编程语言

### Tauri插件
- `tauri-plugin-global-shortcut` - 全局快捷键支持
- `tauri-plugin-dialog` - 文件对话框
- `tauri-plugin-shell` - Shell命令执行
- `tauri-plugin-autostart` - 开机自启动

## 开发环境搭建

### 前置要求
1. Node.js 18+ 和 npm
2. Rust 和 Cargo（通过 [rustup](https://rustup.rs/) 安装）
3. Windows: Microsoft Visual Studio C++ Build Tools

### 安装依赖

```bash
# 进入项目目录
cd speak-keyboard-tauri

# 安装Node.js依赖
npm install

# Rust依赖会在首次运行时自动下载
```

## 运行开发环境

```bash
# 开发模式（热重载）
npm run tauri dev
```

这将：
1. 启动Vite开发服务器（端口1420）
2. 编译Rust代码
3. 打开应用窗口

## 构建生产版本

```bash
# 构建应用
npm run tauri build
```

构建产物位于 `src-tauri/target/release/`

## 主要功能说明

### 1. 悬浮窗 (Widget)
- **位置**: `src/components/Widget.vue`
- **功能**:
  - 可拖拽移动（通过 CSS `-webkit-app-region: drag`）
  - 麦克风按钮控制录音
  - 实时状态显示
  - 自定义标题栏（高度 28px，仅最小化与关闭）
  - 最小化到任务栏（见下）

### 2. 设置窗口 (Settings)
- **位置**: `src/components/Settings.vue`
- **功能**:
  - 替换词典管理
  - 通用设置（快捷键、自启动）
  - 统计信息展示

### 3. 系统托盘
- **位置**: `src-tauri/src/lib.rs`
- **功能**:
  - 系统托盘图标
  - 右键菜单（显示/退出）
  - 左键点击显示主窗口

### 4. 全局快捷键
- **默认**: F2
- **功能**: 全局触发录音开始/停止
- **实现**: `tauri-plugin-global-shortcut`

## 窗口配置

### Widget窗口
- 尺寸: 192x180
- 无边框 (`decorations: false`)
- 透明背景 (`transparent: true`)
- 始终置顶 (`alwaysOnTop: true`)
- 默认不在任务栏显示 (`skipTaskbar: true`)
  - 但当用户点击“最小化”时，后端会临时 `set_skip_taskbar(false)` 并调用 `minimize()`，从而在任务栏可见
  - 通过托盘或命令恢复显示时，后端会再次 `set_skip_taskbar(true)`，回归悬浮窗形态

### Settings窗口
- 尺寸: 500x550
- 有边框
- 居中显示
- 默认隐藏

## API接口

### Tauri Commands (Rust → Frontend)

```javascript
import { invoke } from '@tauri-apps/api/core';

// 开始录音
await invoke('start_recording');

// 停止录音并获取结果
const text = await invoke('stop_recording');

// 获取录音状态
const isRecording = await invoke('get_recording_state');

// 切换窗口可见性
await invoke('toggle_window_visibility', { label: 'settings' });

// 最小化窗口（widget 会最小化到任务栏）
await invoke('minimize_window', { label: 'widget' });
```

### Events (Rust → Frontend)

```javascript
import { listen } from '@tauri-apps/api/event';

// 监听全局快捷键
await listen('global-shortcut-pressed', (event) => {
  console.log('快捷键被按下:', event.payload);
});
```

## 下一步开发

### 待实现功能
1. **与Python后端集成**
   - 调用现有的`app/transcribe.py`进行语音转录
   - 通过Shell插件启动Python进程
   
2. **配置持久化**
   - 保存替换词典到文件
   - 读取用户设置
   
3. **统计功能**
   - 记录使用时长
   - 计算节省时间
   - 统计转录字数

4. **悬浮窗增强**
   - 支持调整大小
   - 记住窗口位置
   
5. **音频处理**
   - 实时音频可视化
   - VAD（语音活动检测）集成

## 调试技巧

### 查看Rust日志
```bash
# Windows PowerShell
$env:RUST_LOG="debug"
npm run tauri dev
```

### 查看前端控制台
在应用运行时，右键选择"检查元素"打开DevTools

### 常见问题

**Q: 全局快捷键不工作？**
A: 确保没有其他应用占用F2快捷键

**Q: 窗口无法透明？**
A: Windows需要启用透明度支持，检查系统设置

**Q: Rust编译错误？**
A: 运行 `cargo clean` 然后重试

## 常见坑点与解决方案

### 坑点1: Tauri窗口事件监听权限问题 (2025-10-02)

#### 问题现象
在设置页面修改快捷键后，Widget悬浮窗的显示文字没有立即更新，只有重启项目才会生效。悬浮窗始终显示"按F2或点击开始"，即使快捷键已经改为其他键。

#### 问题表现
- Settings页面调用 `invoke('set_recording_hotkey')` 显示成功
- Rust后端日志显示快捷键注册成功
- Rust后端日志显示事件发送成功：`[rust] 事件发送成功`
- 但Widget窗口**完全收不到** `recording-hotkey-updated` 事件
- Widget控制台出现权限错误（易被忽略）

#### 根本原因
Tauri 2.0的安全机制要求显式配置每个窗口的权限。默认配置文件 `src-tauri/capabilities/default.json` 中只包含了 `"main"` 窗口：

```json
{
  "windows": ["main"],  // ❌ 只有main窗口有权限
  "permissions": [
    "core:default",
    "opener:default"
  ]
}
```

这导致Widget和Settings窗口无法使用 `listen()` 监听事件，错误信息为：
```
Uncaught (in promise) event.listen not allowed on window "widget"
allowed on: [windows: "main", URL: local]
```

#### 排查过程
1. **初步假设**：以为是前端调用参数格式错误（`{ payload: {...} }` vs `{ ... }`）
2. **验证后端**：添加Rust日志，确认后端成功发送事件
3. **验证前端**：添加前端日志，发现Widget根本没有收到事件
4. **关键发现**：打开Widget的DevTools，发现权限错误提示
5. **定位问题**：检查 `capabilities/default.json`，发现只配置了main窗口

#### 解决方案
修改 `src-tauri/capabilities/default.json`，将所有窗口添加到权限列表：

```json
{
  "$schema": "../gen/schemas/desktop-schema.json",
  "identifier": "default",
  "description": "Capability for all windows",
  "windows": ["main", "widget", "settings"],  // ✅ 添加所有窗口
  "permissions": [
    "core:default",
    "opener:default"
  ]
}
```

#### 经验总结
1. **Tauri 2.0的权限机制非常严格**，每个窗口都需要显式配置才能使用事件监听
2. **权限错误容易被忽略**，因为只在对应窗口的DevTools中显示，不在终端中显示
3. **排查跨窗口通信问题时，优先检查权限配置**，再检查代码逻辑
4. **开发多窗口应用时，记得给每个窗口配置权限**
5. **调试时务必打开所有窗口的DevTools**，不要只看主窗口或终端日志

#### 预防措施
- 新建窗口时，立即在 `capabilities/default.json` 中添加窗口标签
- 如果窗口需要事件监听，确保在 `windows` 数组中包含该窗口
- 项目初始化时可以直接配置 `"windows": ["*"]` 允许所有窗口（注意安全性）

#### 相关文件
- `src-tauri/capabilities/default.json` - 权限配置
- `src/components/Widget.vue` - 监听事件的前端代码
- `src-tauri/src/lib.rs` - 发送事件的后端代码（第563-577行）

## 贡献指南

1. 创建功能分支
2. 编写代码并测试
3. 提交Pull Request

## 许可证

[待定]

