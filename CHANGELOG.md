# 更新日志 (Changelog)

## [2.1.1] - 2025-10-03

### 🧩 Tauri 集成 Python 后端（onedir 侧车）

- 新增：支持将 PyInstaller onedir 打包的 `bridge` 整目录随 Tauri 安装包分发。
- Rust 后端（`speak-keyboard/src-tauri/src/lib.rs`）启动顺序：
  - 优先查找并启动安装包内的 `resources/bin/bridge/bridge.exe`（或同级候选）；
  - 若未找到，回退到开发态 `python -m app.bridge`（自动探测虚拟环境/系统 python）。

### 🔧 配置变更（Tauri）

- `speak-keyboard/src-tauri/tauri.conf.json`：
  - `bundle.resources` 增加 `../bin/bridge`，将 onedir 目录整体打入安装包。
  - 将原先通配 `../bin/bridge/**` 改为 `../bin/bridge`，避免 Windows 下 WiX 打包阶段可能出现的递归扫描引发的栈溢出。

### 🚀 构建与运行

- 准备：将 PyInstaller 产物放到 `speak-keyboard/bin/bridge/bridge.exe`（旁边保留 internal 等文件）。
- 打包安装包：
  ```powershell
  cd speak-keyboard
  npm ci
  npm run build
  npm run tauri build
  ```
- 运行验证：安装后按 F2 录音/转写；任务管理器应看到子进程 `bridge.exe`。

### ⚠️ 注意事项

- onedir 的目录（含 internal）为运行必需，不能删除。
- 首次 MSI 构建会下载/解压 WiX，且打包大目录较慢（3–10 分钟属正常）。
- 模型文件不随包分发；首次运行由程序自动下载到用户缓存。


## [2.1.0] - 2025-10-01

### 🎉 新增功能

#### 数据集收集功能（Dataset Collection）

为模型微调场景设计的数据收集功能，可自动保存每次转录的音频和文本。

**核心特性：**
- **可选启用**：通过命令行参数 `--save-dataset` 启用，不影响正常使用
- **自定义目录**：支持 `--dataset-dir` 指定保存位置（默认 `dataset/`）
- **标准格式**：JSONL 格式，每行一条记录，方便后续处理
- **完整信息**：保存音频文件、转录文本、元数据（时长、置信度等）
- **原子操作**：文件写入使用原子操作，确保数据完整性
- **容错设计**：数据保存失败不影响正常的语音输入功能

**使用方法：**
```bash
# 启用数据集收集
python main.py --save-dataset

# 自定义保存目录
python main.py --save-dataset --dataset-dir my_training_data
```

**数据格式：**
```
dataset/
├── audio/                          # 音频文件
│   └── 20251001_120000_123456-abcd1234.wav
└── dataset.jsonl                   # 元数据（JSONL格式）
```

**元数据字段：**
- `id`: 唯一标识符（时间戳 + UUID）
- `audio`: 音频文件相对路径
- `text`: 转录后的文本（经过后处理）
- `raw_text`: 原始转录文本（模型直接输出）
- `duration`: 音频时长（秒）
- `sample_rate`: 采样率
- `inference_latency`: 推理耗时（秒）
- `confidence`: 转录置信度（0-1）
- `timestamp`: 转录时间戳（UTC）

**音频格式与默认目录：**
- 音频编码：WAV（16-bit PCM，单声道）
- 采样率：来自配置 `audio.sample_rate`（默认 16000Hz）
- 保存位置：默认 `dataset/`，可通过 `--dataset-dir` 覆盖

### 🔧 技术实现

#### AOP 设计模式
采用面向切面编程（AOP）思想，通过装饰器模式包装 result handler：
- **零侵入**：不修改原有业务代码
- **可插拔**：可随时启用/禁用
- **隔离性**：数据保存逻辑与转录逻辑完全分离

```python
# 原始 handler
worker.on_result = _make_result_handler(...)

# 启用数据集收集时自动包装
if args.save_dataset:
    worker.on_result = wrap_result_handler(worker.on_result, worker, dataset_dir)
```

#### 执行顺序优化
先执行原始 handler（确保语音输入正常），再保存数据集（失败不影响功能，AOP 包装器会吞掉异常并记录日志）：
```python
# 1. 先执行原始逻辑（语音输入）
handler_result = handler(result)

# 2. 再保存数据集（容错处理）
try:
    save_dataset()
except Exception:
    logger.error("保存失败但不影响正常使用")
```

#### 日志增强
- 启动时显示数据保存路径
- 每次保存成功记录样本 ID 和文本预览
- 保存失败时记录详细错误信息和堆栈
- 跳过低质量样本时记录原因

### 📝 文档更新

- **新增** `docs/dataset-collection.md`：数据集收集功能完整文档
  - 使用方法和命令行参数
  - 数据格式说明
  - 数据处理示例代码
  - 微调建议和最佳实践
  - 常见问题解答

- **新增** `scripts/view_dataset.py`：数据集查看和统计工具
  - 显示数据集统计信息（样本数、总时长、平均置信度等）
  - 查看最近的样本
  - 过滤低质量样本
  - 支持命令行参数自定义

### 🛠️ 配套工具

#### 数据集查看工具
```bash
# 查看数据集统计
python scripts/view_dataset.py

# 只显示高质量样本
python scripts/view_dataset.py --filter --min-confidence 0.85
```

**功能：**
- 统计总样本数、总时长、平均时长
- 显示平均推理时间、置信度
- 文本长度统计（平均、最大、最小）
- 查看最近N条样本
- 过滤低质量样本并重新统计

### 🔍 技术细节

#### 新增文件
- `app/plugins/__init__.py`: 插件包初始化（1行）
- `app/plugins/dataset_recorder.py`: 数据集记录器核心实现（109行）
- `docs/dataset-collection.md`: 完整使用文档（236行）
- `scripts/view_dataset.py`: 数据集查看工具（131行）

#### 修改文件
- `main.py`: 添加命令行参数和 handler 包装逻辑（+6行）
- `.gitignore`: 排除 `dataset/` 和 `__pycache__/`（+2行）

#### 新增依赖
无新增外部依赖（仅使用 Python 标准库）

#### 配置变化
无配置文件修改，完全通过命令行参数控制

### 📊 适用场景

1. **个人模型微调**
   - 收集自己的语音数据
   - 针对个人口音、说话习惯微调
   - 提升识别准确率

2. **特定领域优化**
   - 收集专业术语、行业黑话
   - 训练领域适配模型
   - 改善专业场景识别效果

3. **质量监控**
   - 定期检查转录质量
   - 发现模型弱点
   - 收集困难样本

4. **数据分析**
   - 统计使用习惯
   - 分析常用词汇
   - 优化工作流程

### ⚠️ 注意事项

1. **存储空间**：音频文件占用空间较大，建议定期清理或备份
2. **隐私保护**：录音可能包含敏感信息，请妥善保管数据
3. **数据质量**：建议定期检查转录质量，过滤低质量样本
4. **向后兼容**：不使用 `--save-dataset` 参数时，行为与 v2.0 完全一致

### 🎯 使用示例

```bash
# 1. 启动数据收集
python main.py --save-dataset --dataset-dir my_data

# 2. 正常使用语音输入（按 F2 录音）
# ... 使用一段时间 ...

# 3. 查看收集的数据
python scripts/view_dataset.py --dataset-dir my_data

# 4. 过滤高质量数据
python scripts/view_dataset.py --dataset-dir my_data --filter --min-confidence 0.9

# 5. 使用文档中的脚本进行数据处理和微调
```

### 🔜 后续计划

- [ ] 自动去重功能
- [ ] 数据导出为其他格式（CSV、Parquet）
- [ ] 集成数据标注工具
- [ ] 支持数据增强（噪声、速度变化）
- [ ] 自动数据质量评估

---

## [2.0.0] - 2025-10-01

### 🎉 重大更新：异步转录架构

这是一个重大的架构升级版本，大幅提升用户体验和系统性能。

### ✨ 新增功能

#### 异步转录队列
- **立即响应**：按F2停止录音后立即返回（~50ms），无需等待转录完成
- **任务队列**：支持快速连续录音，最多10个任务自动排队处理
- **后台转录**：转录在独立线程中进行，不阻塞用户操作
- **顺序输出**：所有转录按提交顺序自动输出，无内容丢失

#### 状态监控
- 新增 `transcription_stats` 属性，实时显示：
  - 已提交任务数
  - 已完成任务数
  - 队列中等待任务数
  - 录音/转录状态
- 日志中显示队列状态和任务进度

#### 录音大小兜底（新）
- 单次录音大小上限 20MB（可配置 `audio.max_session_bytes`）
- 超限自动停止录音并提交转录
- 日志显示当前/上限（字节与MB）
- 非法配置将回退到默认 20MB 并记录警告

### 🐛 Bug 修复

#### 内存泄漏修复
- **音频缓冲区泄漏**：添加析构函数和cleanup方法，确保缓冲区被清理
- **GPU显存泄漏**：每10次转录后自动清理CUDA缓存
- **临时文件泄漏**：确保临时WAV文件被删除

#### 线程安全与并发控制
- 使用 `threading.Lock` 保护音频缓冲区访问
- 使用 `queue.Queue`（线程安全）进行任务传递
- 修复并发访问缓冲区的潜在问题
- **防重复触发**：热键回调添加200ms防抖，避免快速重复按键
- **锁粒度优化**：缩小锁的持有范围，只在修改共享状态时持有锁，耗时操作移到锁外
- **资源隔离**：stop()方法保存线程引用后再释放锁，避免操作到新会话的资源
- **死锁避免**：capture线程调用stop()时跳过线程join，防止自己等待自己

### ⚡ 性能优化

#### 响应速度
- **停止录音响应**：从 2-3秒 → 50毫秒（**提升60倍**）
- **用户体验**：完全无感知延迟，可立即开始下一次录音

#### 并发能力
- 支持同时进行：1个录音 + 1个转录
- 最多10个任务排队等待处理
- 防止快速连续操作导致的任务丢失

### 🔧 技术改进

#### 代码质量
- 修复裸 `except:` 语句，改为 `except Exception:`
- 添加详细的异常处理和错误日志
- 改进资源清理机制，添加超时保护

#### 架构优化
```
主线程 (热键响应)
  ↓
录音线程 (音频采集)
  ↓
任务队列 (线程安全)
  ↓
转录线程 (后台处理)
  ↓
输出文字 (自动输入)
```

### 📝 文档更新

- 更新 `需求.md`，反映v2.0的异步架构
- 更新 `计划.md`，标记已完成的里程碑
- 新增 `ASYNC_TRANSCRIPTION.md`，详细说明异步转录机制
- 新增 `CHANGELOG.md`，记录版本变更

### 🔍 技术细节

#### 新增文件修改
- `app/transcribe.py`: +120行（异步队列实现）
- `main.py`: +15行（状态显示优化）
- `funasr_server.py`: +30行（CUDA内存清理）

#### 新增依赖
- 无新增外部依赖（仅使用Python标准库）

#### 配置变化
- 无需修改现有配置文件（新增项有默认值）
- 新增 `audio.max_session_bytes`（默认 20MB）
- 移除 `hotkeys.dump_last` 配置项（功能已移除）
- 队列大小硬编码为10（未来可配置）

### ⚠️ 破坏性变更

无破坏性变更，完全向后兼容。

### 📊 性能指标

| 指标 | v1.0 | v2.0 | 提升 |
|------|------|------|------|
| 停止录音响应 | 2-3秒 | 50ms | **60倍** |
| 转录延迟 | 2-3秒 | 1-3秒 | 略有优化 |
| 内存占用 | 可能泄漏 | 自动清理 | **安全** |
| 并发能力 | 无 | 1录+1转 | **新增** |
| 队列容量 | 无 | 10任务 | **新增** |

### 🎯 用户体验改进

#### 使用场景对比

**v1.0 同步模式：**
```
按F2录音 → 说话 → 按F2停止 → [等待2-3秒😴] → 看到文字 → 才能再按F2
```

**v2.0 异步模式：**
```
按F2录音 → 说话 → 按F2停止 → [立即⚡] 按F2录音 → 说话 → 按F2停止 → ...
                    ↓ 2秒后                    ↓ 2秒后
                  文字1出现                   文字2出现
```

### 🧪 测试建议

1. **快速连续录音测试**
   - 快速按F2 4次（录制2段语音）
   - 验证立即响应和按顺序输出

2. **队列压力测试**
   - 快速连续录制10段以上语音
   - 观察队列状态和内存使用

3. **长时间运行测试**
   - 运行数小时，检查内存泄漏
   - 验证GPU显存是否正常释放

### 🔜 后续计划

- [ ] GUI设置页面
- [ ] 模型管理和切换
- [ ] 队列大小可配置
- [ ] 实时进度显示
- [ ] 支持Whisper等其他模型

---

## [1.0.0] - 2025-09-XX

### 初始版本

- 基础语音转文字功能
- F2热键开始/停止录音
- FunASR模型集成
- 同步转录模式
- 文本自动输入

---

**版本格式说明**：
- 主版本号：重大架构变更或破坏性更新
- 次版本号：新功能添加
- 修订号：Bug修复和小改进

