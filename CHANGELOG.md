# 更新日志 (Changelog)

## [2.0.0] - 2025-10-01

### 🎉 重大更新：异步转录架构

这是一个重大的架构升级版本，大幅提升用户体验和系统性能。

### ✨ 新增功能

#### 异步转录队列
- **立即响应**：按F2停止录音后立即返回（~50ms），无需等待转录完成
- **任务队列**：支持快速连续录音，最多10个任务自动排队处理
- **后台转录**：转录在独立线程中进行，不阻塞用户操作
- **顺序输出**：所有转录按提交顺序自动输出，无内容丢失

#### 状态监控
- 新增 `transcription_stats` 属性，实时显示：
  - 已提交任务数
  - 已完成任务数
  - 队列中等待任务数
  - 录音/转录状态
- 日志中显示队列状态和任务进度

#### 录音大小兜底（新）
- 单次录音大小上限 20MB（可配置 `audio.max_session_bytes`）
- 超限自动停止录音并提交转录
- 日志显示当前/上限（字节与MB）
- 非法配置将回退到默认 20MB 并记录警告

### 🐛 Bug 修复

#### 内存泄漏修复
- **音频缓冲区泄漏**：添加析构函数和cleanup方法，确保缓冲区被清理
- **GPU显存泄漏**：每10次转录后自动清理CUDA缓存
- **临时文件泄漏**：确保临时WAV文件被删除

#### 线程安全
- 使用 `threading.Lock` 保护音频缓冲区访问
- 使用 `queue.Queue`（线程安全）进行任务传递
- 修复并发访问缓冲区的潜在问题

### ⚡ 性能优化

#### 响应速度
- **停止录音响应**：从 2-3秒 → 50毫秒（**提升60倍**）
- **用户体验**：完全无感知延迟，可立即开始下一次录音

#### 并发能力
- 支持同时进行：1个录音 + 1个转录
- 最多10个任务排队等待处理
- 防止快速连续操作导致的任务丢失

### 🔧 技术改进

#### 代码质量
- 修复裸 `except:` 语句，改为 `except Exception:`
- 添加详细的异常处理和错误日志
- 改进资源清理机制，添加超时保护

#### 架构优化
```
主线程 (热键响应)
  ↓
录音线程 (音频采集)
  ↓
任务队列 (线程安全)
  ↓
转录线程 (后台处理)
  ↓
输出文字 (自动输入)
```

### 📝 文档更新

- 更新 `需求.md`，反映v2.0的异步架构
- 更新 `计划.md`，标记已完成的里程碑
- 新增 `ASYNC_TRANSCRIPTION.md`，详细说明异步转录机制
- 新增 `CHANGELOG.md`，记录版本变更

### 🔍 技术细节

#### 新增文件修改
- `app/transcribe.py`: +120行（异步队列实现）
- `main.py`: +15行（状态显示优化）
- `funasr_server.py`: +30行（CUDA内存清理）

#### 新增依赖
- 无新增外部依赖（仅使用Python标准库）

#### 配置变化
- 无需修改现有配置文件（新增项有默认值）
- 新增 `audio.max_session_bytes`（默认 20MB）
- 队列大小硬编码为10（未来可配置）

### ⚠️ 破坏性变更

无破坏性变更，完全向后兼容。

### 📊 性能指标

| 指标 | v1.0 | v2.0 | 提升 |
|------|------|------|------|
| 停止录音响应 | 2-3秒 | 50ms | **60倍** |
| 转录延迟 | 2-3秒 | 1-3秒 | 略有优化 |
| 内存占用 | 可能泄漏 | 自动清理 | **安全** |
| 并发能力 | 无 | 1录+1转 | **新增** |
| 队列容量 | 无 | 10任务 | **新增** |

### 🎯 用户体验改进

#### 使用场景对比

**v1.0 同步模式：**
```
按F2录音 → 说话 → 按F2停止 → [等待2-3秒😴] → 看到文字 → 才能再按F2
```

**v2.0 异步模式：**
```
按F2录音 → 说话 → 按F2停止 → [立即⚡] 按F2录音 → 说话 → 按F2停止 → ...
                    ↓ 2秒后                    ↓ 2秒后
                  文字1出现                   文字2出现
```

### 🧪 测试建议

1. **快速连续录音测试**
   - 快速按F2 4次（录制2段语音）
   - 验证立即响应和按顺序输出

2. **队列压力测试**
   - 快速连续录制10段以上语音
   - 观察队列状态和内存使用

3. **长时间运行测试**
   - 运行数小时，检查内存泄漏
   - 验证GPU显存是否正常释放

### 🔜 后续计划

- [ ] GUI设置页面
- [ ] 模型管理和切换
- [ ] 队列大小可配置
- [ ] 实时进度显示
- [ ] 支持Whisper等其他模型

---

## [1.0.0] - 2025-09-XX

### 初始版本

- 基础语音转文字功能
- F2热键开始/停止录音
- FunASR模型集成
- 同步转录模式
- 文本自动输入

---

**版本格式说明**：
- 主版本号：重大架构变更或破坏性更新
- 次版本号：新功能添加
- 修订号：Bug修复和小改进

