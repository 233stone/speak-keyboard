我想开发一个桌面端的软件，Windows系统，这个软件可以将语音输入转为文字，这样就可以不打字了；

我希望能使用开源的funasr作为底座，只要我使用快捷键f2空格，就能开启语音输入，再按一下关闭，你帮我看看怎么实现；

为保证识别准确率，现阶段取消实时分段，改为：停止录音后一次性转写并输出（单次会话“一次转写”）。

### 目标
- 在 Windows 上，用快捷键快速把语音转文字并输入到当前焦点窗口，离线、低延迟、可切换模型（现阶段仅funasr）。

### 使用人群/场景
- 打字慢或双手被占用的用户；在任何可输入文本的应用中（记事本、聊天软件、IDE 等）进行语音输入。

### 平台与环境
- Windows 11+（x64）
- Python 3.10+，离线运行（无云依赖）
- 有麦克风权限

### MVP 范围（已实现/需保持）
- 热键
  - f2：开始/停止监听（冲突时弹窗提示并禁用热键，不做其它动作）
  - **关键行为**：F2 作为录音开关，停止录音时立即返回，转录在后台异步进行
  - **快速连续**：可以立即开始下一次录音，无需等待上一次转录完成
  - （自动）停止录音后将最近一次会话音频保存/覆盖到 `logs/recent.wav`（诊断用）
- 音频采集（会话式）
  - 使用 `sounddevice` 采集，16kHz、单声道；自动选择默认输入设备，异常时回退到首个可用设备
  - 不进行实时分段；停止录音后对整段音频进行转写
  - **会话隔离**：每次开始录音时完全清理历史状态，避免上次会话内容混入
- 语音识别
  - 引擎：`funasr`
  - 自动检测系统语言（中文系统默认 `zh`，否则自动语言识别）
- **异步转写流程** ✅ (已实现 v2.0)
  - 停止录音后立即返回（~50ms响应），音频数据提交到转录队列
  - **异步处理**：转录在后台独立线程进行，不阻塞录音操作
  - **任务队列**：支持快速连续录音，最多10个任务排队等待转录
  - **顺序输出**：转录完成后按提交顺序自动输出文本
  - **优雅停止**：程序退出时等待队列清空（最多10秒），确保不遗漏任何内容
- 输出方式
  - 默认：直接"打字"注入焦点窗口（避免剪贴板占用问题）
  - 备选：剪贴板粘贴（主线程操作、重试、自动恢复剪贴板）
- 单次转写策略
  - 停止后进行一次性转写，无实时输出
  - 安全兜底：单次录音大小上限 20MB（可配置 `audio.max_session_bytes`），达到阈值自动停止并提交转录，日志显示当前/上限（字节与MB）
- 日志与诊断
  - 关键事件：热键、录音开始/结束、识别结果长度、输出动作、推理耗时
  - 诊断：`logs/recent.wav` 快速验证是否录到音（每次停止后自动覆盖）
  - 应用日志：`logs/app.log`

### 非功能需求
- **低延迟** ✅ (已优化)
  - 停止录音到返回：< 50ms（立即响应，提升60倍）
  - 转录到文本输出：1-3秒（后台处理，与音频长度相关）
  - 用户体验：无感知延迟，可立即开始下一次录音
- 稳定性：无设备时/权限不足/剪贴板占用等场景要有可理解的日志与降级（typing）
- **会话完整性** ✅ (已强化)
  - 所有录制内容完整转录，无内容丢失
  - 任务队列机制确保按顺序处理
  - 程序退出前等待队列清空
- **内存管理** ✅ (已优化)
  - 自动清理音频缓冲区和临时文件
  - GPU显存定期清理（每10次转录）
  - 优雅的资源释放机制
- 隐私：本地推理，不上传音频/文本

### 错误处理与提示
- f2注册失败：弹窗提示冲突，热键禁用（不影响程序运行）
- 无可用麦克风：日志告警并继续运行（但无法录音）
- 剪贴板失败：自动降级为直接打字
- 识别为空：输出跳过并记录日志



### 验收标准（MVP）✅ 
- **基本功能**：在记事本中按 f2 开始录音，讲话后按 f2 停止，立即可再次录音，文本按顺序自动输出
- **会话隔离**：每次开始新的录音会话时，不会包含上次会话的历史内容
- **快速响应** ✅ (v2.0新增)：按第二次 f2 时立即返回（~50ms），可马上开始下一次录音
- **异步转录** ✅ (v2.0新增)：转录在后台进行，支持快速连续录音，任务自动排队处理
- **队列机制** ✅ (v2.0新增)：最多10个任务排队，队列满时记录错误但不阻塞用户
- **状态监控** ✅ (v2.0新增)：日志显示队列状态（已提交/已完成/等待中）
- **输出可靠**：若剪贴板失败则降级逐字符打字
- f2 冲突时：启动后提示，不注册热键；手动调用接口仍可开始/停止（后续可更改热键）
- 每次停止后自动生成/覆盖 `logs/recent.wav`（最近一次会话音频）
- **增强日志**：包含热键触发、录音开始/结束、识别结果长度、输出动作、推理耗时、队列状态、GPU 信息

### 已完成的优化 (v2.0)
- ✅ **异步转录架构**：停止录音立即返回，转录在后台线程进行
- ✅ **任务队列机制**：支持快速连续录音，最多10个任务排队
- ✅ **内存泄漏修复**：音频缓冲区自动清理，GPU显存定期释放
- ✅ **线程安全**：使用线程锁和队列保护共享资源
- ✅ **状态监控**：实时显示转录进度和队列状态
- ✅ **优雅清理**：程序退出时等待队列清空，无内容丢失

### 不在本次范围（后续版本）
- GUI 设置页（设备选择、热键自定义、语言/模型切换、输出模式切换、GPU/CPU 指定）
- 模型管理（本地路径选择、HuggingFace 下载、显存建议）
- 边说边"增量粘贴"（带去重和节流）
- 更强注入通道（Win32 SendInput，以适配个别应用的键盘拦截）
- 我希望不是将funasr内置，而是可以自己选择使用任何模型，就向ollma一样，用户可以下载自己想要的模型，只要再gui中选择即可；
