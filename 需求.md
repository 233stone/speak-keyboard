我想开发一个桌面端的软件，Windows系统，这个软件可以将语音输入转为文字，这样就可以不打字了；

我希望能使用开源的funasr作为底座，只要我使用快捷键f2空格，就能开启语音输入，再按一下关闭，你帮我看看怎么实现；

为保证识别准确率，现阶段取消实时分段，改为：停止录音后一次性转写并输出（单次会话“一次转写”）。

### 目标
- 在 Windows 上，用快捷键快速把语音转文字并输入到当前焦点窗口，离线、低延迟、可切换模型（现阶段仅funasr）。

### 使用人群/场景
- 打字慢或双手被占用的用户；在任何可输入文本的应用中（记事本、聊天软件、IDE 等）进行语音输入。

### 平台与环境
- Windows 11+（x64）
- Python 3.10+，离线运行（无云依赖）
- 有麦克风权限

### MVP 范围（已实现/需保持）
- 热键
  - f2：开始/停止监听（冲突时弹窗提示并禁用热键，不做其它动作）
  - **关键行为**：Alt+Space 纯粹作为录音开关，不参与转录过程；停止录音但不中断正在进行的转录
  - Ctrl+Alt+S：保存最近上一次的录音语音到 `log/recent.wav`（诊断用）
- 音频采集（会话式）
  - 使用 `sounddevice` 采集，16kHz、单声道；自动选择默认输入设备，异常时回退到首个可用设备
  - 不进行实时分段；停止录音后对整段音频进行转写
  - **会话隔离**：每次开始录音时完全清理历史状态，避免上次会话内容混入
- 语音识别
  - 引擎：`funasr`
  - 自动检测系统语言（中文系统默认 `zh`，否则自动语言识别）
- **单次转写流程**
  - 停止录音后合并本次会话的音频缓冲并一次性调用 FunASR 转写
  - **优雅停止**：停止后仅等待本次会话的单次转写完成，确保不遗漏本次内容
- 输出方式
  - 默认：直接"打字"注入焦点窗口（避免剪贴板占用问题）
  - 备选：剪贴板粘贴（主线程操作、重试、自动恢复剪贴板）
- 单次转写策略
  - 停止后进行一次性转写，无实时输出
- 日志与诊断
  - 关键事件：热键、录音开始/结束、识别结果长度、输出动作、推理耗时
  - 诊断：`log/recent.wav` 快速验证是否录到音
  - 应用日志：`log/app.log`

### 非功能需求
- 低延迟：停止录音到文本输出 < 1–2 秒（与音频长度相关）
- 稳定性：无设备时/权限不足/剪贴板占用等场景要有可理解的日志与降级（typing）
- **会话完整性**：确保停止录音时所有已录制内容都能完整转录输出，无内容丢失
- 隐私：本地推理，不上传音频/文本

### 错误处理与提示
- f2注册失败：弹窗提示冲突，热键禁用（不影响程序运行）
- 无可用麦克风：日志告警并继续运行（但无法录音）
- 剪贴板失败：自动降级为直接打字
- 识别为空：输出跳过并记录日志



### 验收标准（MVP）
- **基本功能**：在记事本中按 f2 开始录音，讲话后按 f2 停止，等待单次转写完成并一次性输出到光标处
- **会话隔离**：每次开始新的录音会话时，不会包含上次会话的历史内容
- **优雅停止**：按第二次 f2 时立即停止录音，随后仅等待本次会话的单次转写完成并输出
- **输出可靠**：若剪贴板失败则降级逐字符打字
- f2 冲突时：启动后提示，不注册热键；手动调用接口仍可开始/停止（后续可更改热键）
- 按 Ctrl+Alt+S：生成 `log/recent.wav`，保存最近一次的录音音频
- **增强日志**：包含热键触发、录音开始/结束、识别结果长度、输出动作、推理耗时、GPU 信息

### 不在本次范围（后续版本）
- GUI 设置页（设备选择、热键自定义、语言/模型切换、输出模式切换、GPU/CPU 指定）
- 模型管理（本地路径选择、HuggingFace 下载、显存建议）
- 边说边“增量粘贴”（带去重和节流）
- 更强注入通道（Win32 SendInput，以适配个别应用的键盘拦截）
- 我希望不是将funasr内置，而是可以自己选择使用任何模型，就向ollma一样，用户可以下载自己想要的模型，只要再gui中选择即可；
